#- dockercompose - build
#- publish obrazu

name: Continuous Deployment

on:
  push:
    branches:
      - master
  release:
    types: [published]
jobs:
  Build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Build release image
        run: |
          docker build --tag nice_project nice_project
          docker build --tag nginx nginx
      - name: Tagging realease image
      # jeśli byłoby więcej obrazów to można zastosować matrix + zmienne?
        run: |
          docker tag nice_project "$DOCKER_USER"/nice_project_nice_project:latest
          docker tag nginx "$DOCKER_USER"/nice_project_nginx:latest
          SHORT_SHA="${GITHUB_SHA:0:7}"
          echo '::set-env name=SHORT_SHA::'"$SHORT_SHA"
          docker tag nice_project "$DOCKER_USER"/nice_project_nice_project:"$SHORT_SHA"
          docker tag nginx "$DOCKER_USER"/nice_project_nginx:"$SHORT_SHA"
      - name: Tagging image with a release tag
        if: ${{ github.event_name == 'release' }}
        run: |
          TAG="${GITHUB_REF##*/}"
          echo '::set-env name=TAG::'"$TAG"
          docker tag nice_project "$DOCKER_USER"/nice_project_nice_project:"$TAG"
          docker tag nginx "$DOCKER_USER"/nice_project_nginx:"$TAG"
      - name: Loging into dockerhub
        run: 
          echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USER" --password-stdin
      - name: Pushing images
        run: |
          docker push "$DOCKER_USER"/nice_project_nice_project:latest
          docker push "$DOCKER_USER"/nice_project_nice_project:"$SHORT_SHA"
          docker tag nginx "$DOCKER_USER"/nice_project_nginx:latest
          docker tag nginx "$DOCKER_USER"/nice_project_nginx:"$SHORT_SHA"
      - name: Pushing image with a release tag
        if: ${{ github.event_name == 'release' }}
        run: |
          docker push "$DOCKER_USER"/nice_project_nice_project:"$TAG"
          docker tag nginx "$DOCKER_USER"/nice_project_nginx:"$TAG"
      - name: Logint out of dockerhub
        run: docker logout
    env:
      DOCKER_USER: ${{ secrets.DOCKERHUB_ACCOUNT_NAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}